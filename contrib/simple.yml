settings:
  clone_dir: ~/z/gl
  extract_dir: ~/z/dy
  host_facts:
    lock_period:
      '*': 600
      natrium: 3600
  versions:
    chezmoi: 2.29.0
    firefox: 108.0.1
    gcloud: 412.0.0
    gh: 2.21.1
    goland: 2022.3.1
    just: 1.6.0
    nvim: 0.8.0
    sonixd: 0.15.3
    tectonic: 0.12.0
    terraform: 1.3.3
    vscode: 1.74.2

preflight:
  - task: Enable RPM Fusion
    when: is-fedora
    steps:
      - name: shell
        cmd: dnf install -y https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm
        sudo: true
    unless:
      cmd: dnf list --installed rpmfusion-free-release
  - task: Enable Docker repo
    when: is-fedora
    steps:
      - name: shell
        cmd: |
          sudo dnf -y install dnf-plugins-core
          sudo dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo
        sudo: true
    unless:
      cmd: dnf list --installed docker-ce
  - task: Add Spotify repo
    when: is-ubuntu
    unless:
      stat: /etc/apt/sources.list.d/spotify.list
    steps:
      - name: shell
        sudo: true
        cmd: |
          curl -sS https://download.spotify.com/debian/pubkey_5E3C45D7B312C643.gpg | sudo apt-key add -
          echo 'deb http://repository.spotify.com stable non-free' | sudo tee /etc/apt/sources.list.d/spotify.list
          apt update

archives:
  - url: https://github.com/twpayne/chezmoi/releases/download/v${version}/chezmoi_${version}_linux_amd64.tar.gz
    name: chezmoi
    unless:
      cmd: chezmoi --version
      post: split 2 | cut 1 | cut -1
    target: chezmoi
    link:
      - chezmoi/chezmoi
  - url: https://update.code.visualstudio.com/${version}/linux-x64/stable
    name: vscode
    unless:
      cmd: code --version
      post: head 0
    link:
      - VSCode-linux-x64/bin/code
  - url: https://download-installer.cdn.mozilla.net/pub/firefox/releases/${version}/linux-x86_64/en-US/firefox-${version}.tar.bz2
    name: firefox
    unless:
      cmd: firefox --version
    link:
      - firefox/firefox
  - url: https://dl.google.com/dl/cloudsdk/channels/rapid/google-cloud-sdk.tar.gz
    name: gcloud
    unless:
      cmd: gcloud --version
      post: head 0 | split 3
    link:
      - google-cloud-sdk/bin/gcloud
  - url: https://github.com/cli/cli/releases/download/v${version}/gh_${version}_linux_amd64.tar.gz
    name: gh
    unless:
      cmd: gh version
      post: head 0 | split 2
    link:
      - gh_${version}_linux_amd64/bin/gh
  - url: https://download.jetbrains.com/go/goland-${version}.tar.gz
    name: goland
    link:
      - GoLand-${version}/bin/goland.sh
    unless:
      stat: ${extract_dir}/GoLand-${version}/bin/goland.sh
  - url: https://github.com/casey/just/releases/download/${version}/just-${version}-x86_64-unknown-linux-musl.tar.gz
    name: just
    target: just
    unless:
      cmd: just -V
      post: split 1
    link:
      - just/just
  - url: https://github.com/neovim/neovim/releases/download/v${version}/nvim-linux64.tar.gz
    name: nvim
    link:
      - nvim-linux64/bin/nvim
    unless:
      cmd: nvim --version
      post: head 0 | split 1 | split- 0 | cut 1
    when: is-ubuntu
  - url: https://github.com/jeffvli/sonixd/releases/download/v${version}/Sonixd-${version}-linux-x64.tar.xz
    name: sonixd
    link:
      - Sonixd-${version}-linux-x64/sonixd
    unless:
      stat: ${extract_dir}/Sonixd-${version}-linux-x64/sonixd
    set_permissions: true
    execute_after: |
      find ${extract_dir}/Sonixd-${version}-linux-x64/ -name sonixd -exec chmod 755 '{}' \;
  - url: https://github.com/tectonic-typesetting/tectonic/releases/download/tectonic%40${version}/tectonic-${version}-x86_64-unknown-linux-musl.tar.gz
    name: tectonic
    unless:
      cmd: tectonic --version
      post: split 1
    target: tectonic
    link:
      - tectonic/tectonic
  - url: https://releases.hashicorp.com/terraform/${version}/terraform_${version}_linux_amd64.zip
    unless:
      cmd: terraform -version
      post: head 0 | split 1 | cut 1
    name: terraform
    target: terraform
    link:
      - terraform/terraform

packages:
  .*:
    - acpi
    - ansible
    - at
    - autoconf
    - bpftrace
    - cargo
    - cmake
    - colordiff
    - curl
    - dunst
    - emacs
    - fish
    - gcc
    - gimp
    - git
    - git-crypt
    - golang
    - gnupg2
    - groff
    - highlight
    - htop
    - i3lock
    - jq
    - maim
    - make
    - most
    - mpv
    - mutt
    - npm
    - openssh-server
    - pass
    - playerctl
    - podman
    - pwgen
    - qutebrowser
    - ranger
    - ripgrep
    - rlwrap
    - rustfmt
    - rust-src
    - rofi
    - sbcl
    - strace
    - surfraw
    - sxiv
    - texinfo
    - thunderbird
    - tig
    - tmux
    - unzip
    - urlview
    - w3m
    - wget
    - whois
    - wireguard-tools
    - wireshark
    - xdotool
    - xsel
    - zathura
    - zathura-pdf-poppler
    - zeal
  ubuntu:
    - apt-listchanges
    - avr-libc
    - avrdude
    - bpfcc-tools
    - binutils-arm-none-eabi
    - binutils-avr
    - clang
    - dconf-cli
    - dfu-programmer
    - dfu-util
    - dnsutils
    - docker.io
    - gcc-arm-none-eabi
    - gcc-avr
    - gettext
    - imagemagick
    - ipython3
    - libclang-dev
    - libevent-dev
    - libfontconfig1-dev
    - libmnl-dev
    - libnewlib-arm-none-eabi
    - libnotify-bin
    - libnotify-dev
    - libpython3-dev
    - libssl-dev
    - libtool
    - libtool-bin
    - libx11-dev
    - libxcb-render0-dev
    - libxcb-screensaver0-dev
    - libxcb-shape0-dev
    - libxcb-xfixes0-dev
    - libxext-dev
    - libxfixes-dev
    - ncal
    - network-manager
    - pavucontrol
    - python3-dev
    - spotify-client
    - sqlite3
    - suckless-tools
    - teensy-loader-cli
    - unattended-upgrades
    - x11-utils
    - x11proto-dev
    - xfonts-terminus
  fedora:
    - ImageMagick
    - NetworkManager-tui
    - arm-none-eabi-binutils-cs
    - arm-none-eabi-gcc-cs
    - arm-none-eabi-newlib
    - automake
    - avr-binutils
    - avr-gcc
    - avr-libc
    - containerd.io
    - dmenu
    - docker-ce
    - docker-ce-cli
    - docker-compose-plugin
    - neovim
    - openssl-devel
    - pinentry-gtk
    - pipewire-pulseaudio
    - pipewire-utils
    - podman
    - pulseaudio-utils
    - python3-devel
    - python3-ipython
    - python3-virtualenv
    - sqlite
    - terminus-fonts
    - terminus-fonts-legacy-x11
    - upower
    - wmname
    - xdpyinfo
    - xev
    - xmodmap
    - xorg-x11-proto-devel
    - xprop
    - xrandr
    - xsetroot

unwanted_packages:
  ubuntu:
    - snapd

cargo:
  - name: alacritty
    unless:
      cmd: alacritty --version
  - name: bat
    unless:
      cmd: bat -V
  - name: exa
    unless:
      cmd: exa -v
  - name: fd-find
    unless:
      cmd: fd -V
  - name: xidlehook
    unless:
      cmd: xidlehook -V
    bins: true
  - name: https://github.com/femnad/leth
    unless:
      cmd: leth -V
      post: split 1
    version: 0.4.1
  - name: https://github.com/ogham/dog.git
    unless:
      cmd: dog -v
  - name: bottom
    unless:
      cmd: btm -V
  - name: git-delta
    unless:
      cmd: delta -V
      # Escape characters in -V output for 0.14.0
      post: head 0 | split 1
    version: 0.14.0

tasks:
  - task: Stumpwm
    unless:
      cmd: stumpwm --version
    steps:
    - name: download
      url: https://beta.quicklisp.org/quicklisp.lisp
      dir: ${extract_dir}/quicklisp/quicklisp.lisp
      unless:
        stat: ${extract_dir}/quicklisp/quicklisp.lisp
    - name: cmd
      cmd: sbcl --load ${extract_dir}/quicklisp/quicklisp.lisp --eval '(quicklisp-quickstart:install)' --non-interactive
    - name: rename
      src: ~/quicklisp
      dst: ~/.cache/quicklisp
    - name: quicklisp
      pkg:
        - alexandria
        - clx
        - cl-ppcre
    - name: git
      repo: https://github.com/stumpwm/stumpwm.git
      dir: ${clone_dir}/stumpwm
    - name: cmd
      cmd: |
        ./autogen.sh
        ./configure
        make
      pwd: ${clone_dir}/stumpwm
    - name: cmd
      cmd: make install
      pwd: ${clone_dir}/stumpwm
      sudo: true
  - task: Neovim packages
    when: not neovim-ready
    steps:
      - name: cmd
        cmd: nvim +PlugInstall +qa
  - task: Apply common chezmoi
    when: ssh-ready
    unless:
      stat: ~/.gitconfig.user
    steps:
      - name: git
        repo: git@gitlab.com:femnad/chezmoi-common.git
        dir: ~/.local/share/chezmoi-common
      - name: cmd
        cmd: chezmoi apply -S ~/.local/share/chezmoi-common
  - task: Change https auth to git auth
    when: ssh-ready
    steps:
      - name: cmd
        cmd: ~/bin/https-to-git.sh
        pwd: ~/.local/share/chezmoi
      - name: cmd
        cmd: ~/bin/https-to-git.sh
        pwd: ~/z/fm/fup
  - task: Pull SSH key
    when: ssh-pull-ready
    unless:
      stat: ~/.config/gcloud/application_default_credentials.json
    steps:
      - name: cmd
        cmd: pup
  - task: Install pyright
    unless:
      cmd: pyright --version
    steps:
      - name: cmd
        cmd: npm install -g pyright
        sudo: true
  - task: Clone tmux plugin manager
    steps:
      - name: git
        repo: https://github.com/tmux-plugins/tpm
        dir: ~/.config/tmux/plugins/tpm
    unless:
      stat: ~/.config/tmux/plugins/tpm
  - task: Init tmux plugins
    steps:
      - name: cmd
        cmd: tmux run-shell ~/.config/tmux/plugins/tpm/bin/install_plugins
    unless:
      stat: ~/.config/tmux/plugins/tmux-yank
    when: in-tmux
  - task: Clone and symlink stumpish
    steps:
      - name: git
        repo: https://github.com/stumpwm/stumpwm-contrib.git
        dir: ${clone_dir}/stumpwm-contrib
      - name: symlink
        link_src: ~/bin/stumpish
        link_target: ${clone_dir}/stumpwm-contrib/util/stumpish/stumpish
    unless:
      cmd: stumpish --help
  - task: Clone and link clipnotify
    unless:
      cmd: which clipnotify
    steps:
      - name: git
        repo: https://github.com/cdown/clipnotify.git
        dir: ${clone_dir}/clipnotify
      - name: cmd
        cmd: make install
        pwd: ${clone_dir}/clipnotify
        sudo: true
        unless:
          cmd: which clipnotify
  - task: Clone and link clipmenu
    unless:
      cmd: which clipmenud
    steps:
      - name: git
        repo: https://github.com/cdown/clipmenu
        dir: ${clone_dir}/clipmenu
      - name: cmd
        cmd: make install
        pwd: ${clone_dir}/clipmenu
        sudo: true
        unless:
          cmd: which clipmenud
  - task: Install Spotify on fedora
    when: is-fedora
    steps:
      - name: cmd
        cmd: flatpak remote-add flathub https://flathub.org/repo/flathub.flatpakrepo
        sudo: true
        unless:
          cmd: flatpak remotes
          post: contains flathub
      - name: cmd
        cmd: flatpak install -y flathub com.spotify.Client
        unless:
          cmd: flatpak list
          post: contains
      - name: template
        target: ${HOME}/bin/spotify
        mode: '0755'
        content: |
          #!/usr/bin/env bash
          flatpak run com.spotify.Client
  - task: Install Mullvad app
    when: is-ubuntu
    unless:
      cmd: dpkg-query --list mullvad-vpn
    steps:
      - name: cmd
        cmd: |
          wget -q https://mullvad.net/media/app/MullvadVPN-2022.4_amd64.deb -O /tmp/MullvadVPN-2022.4_amd64.deb
          apt install -y /tmp/MullvadVPN-2022.4_amd64.deb
          rm /tmp/MullvadVPN-2022.4_amd64.deb
        sudo: true
  - task: Install Mullvad app
    when: is-fedora
    steps:
      - name: cmd
        cmd: dnf install -y https://mullvad.net/media/app/MullvadVPN-2022.5_x86_64.rpm
        sudo: true
    unless:
      cmd: rpm -q mullvad-vpn
  - task: Set lockscreen
    steps:
      - name: cmd
        cmd: ~/bin/locko
    unless:
      stat: ~/y/i3locko/locko.png
  - task: Enable gsutil
    unless:
      cmd: gsutil version
    steps:
      - name: shell
        cmd: echo '' | ~/bin/gcloud components install gsutil
      - name: symlink
        link_src: ~/bin/gsutil
        link_target: ${extract_dir}/google-cloud-sdk/bin/gsutil
  - task: Clone and symlink vimv
    steps:
      - name: git
        repo: https://github.com/thameera/vimv.git
        dir: ${clone_dir}/vimv
      - name: symlink
        link_src: ~/bin/vimv
        link_target: ${clone_dir}/vimv/vimv
    unless:
      stat: ${clone_dir}/vimv/vimv

go:
  - name: femnad/rabn
    unless:
      cmd: rabn --version
  - name: femnad/fred
    unless:
      cmd: fred --version
      post: split 1
    version: 0.2.2
  - name: aykamko/tag
    unless:
      cmd: tag -V
  - name: gitlab.com/gitlab-org/cli/cmd/glab
    unless:
      cmd: glab version
  - name: charmbracelet/glow
    unless:
      cmd: glow --version
  - name: gokcehan/lf
    unless:
      cmd: lf -version
