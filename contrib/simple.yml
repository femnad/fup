settings:
  clone_dir: ~/foo # only referenced in this file
  extract_dir: ~/bar # only referenced in this file
  self_clone_path: ~/baz # self-clone provisioner references this
  template_dir: ~/fup/templates # template provisioner references this
  virtualenv_dir: ~/venv # python provisioner references this
  # Lookup based on host name, only references in this file
  host_facts:
    lock_period:
      '.*': 600
      qux: 1800
      fred: 3600
  versions:
    gh: 2.29.0

preflight:
  - task: Enable RPM Fusion
    when: is-fedora
    steps:
      - name: shell
        cmd: dnf install -y https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm
        sudo: true
    unless:
      cmd: dnf list --installed rpmfusion-free-release
  - task: Add Spotify repo
    when: is-ubuntu
    unless:
      stat: /etc/apt/sources.list.d/spotify.list
    steps:
      - name: shell
        sudo: true
        cmd: |
          curl -sS https://download.spotify.com/debian/pubkey_5E3C45D7B312C643.gpg | sudo apt-key add -
          echo 'deb http://repository.spotify.com stable non-free' | sudo tee /etc/apt/sources.list.d/spotify.list
          apt update

archives:
  - url: https://github.com/cli/cli/releases/download/v${version}/gh_${version}_linux_amd64.tar.gz
    name: gh
    unless:
      cmd: gh version
      post: head 0 | split 2
    link:
      - gh_${version}_linux_amd64/bin/gh

packages:
  .*:
    - pass
  ubuntu:
    - apt-listchanges
  fedora:
    - dnf-automatic

unwanted_packages:
  ubuntu:
    - snapd

cargo:
  - name: alacritty
    unless:
      cmd: alacritty --version

tasks:
  - task: Install Mullvad app
    when: is-ubuntu
    unless:
      cmd: dpkg-query --list mullvad-vpn
    steps:
      - name: cmd
        cmd: |
          wget -q https://mullvad.net/media/app/MullvadVPN-2023.3_amd64.deb -O /tmp/MullvadVPN-2023.3_amd64.deb
          apt install -y /tmp/MullvadVPN-2023.3_amd64.deb
          rm /tmp/MullvadVPN-2023.3_amd64.deb
        sudo: true
  - task: Install Mullvad app
    when: is-fedora
    steps:
      - name: cmd
        cmd: dnf install -y https://mullvad.net/media/app/MullvadVPN-2023.3_x86_64.rpm
        sudo: true
    unless:
      cmd: rpm -q mullvad-vpn

go:
  - name: charmbracelet/glow
    unless:
      cmd: glow --version

python:
  - name: qmk
    link:
      - qmk
    unless:
      cmd: qmk -V

services:
  - name: grobi
    unit:
      exec: grobi watch -v
      desc: Automatically configure monitors/outputs for Xorg via RANDR
      env:
        GROBI_CONFIG: ${HOME}/.config/grobi/grobi.conf
    dont_enable: true
    dont_start: true
  - name: dnf-automatic.timer
    system: true
    dont_template: true
    when: is-fedora

template:
  - src: touchpad.conf
    dest: /etc/X11/xorg.conf.d/30-touchpad.conf
    when: is-laptop
  - src: unattended-upgrades.conf
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    when: is-ubuntu

postflight:
  # Useful if Go binaries were installed before GOPATH was set
  - task: Move go dir
    when: gopath-set
    unless:
      stat: ${GOPATH}
    steps:
      - name: rename
        src: ~/go
        target: ${GOPATH}

github_user_keys:
  # Not a user
  user: cli

ensure_dirs:
  - ~/taxes

accept_host_keys:
  - github.com
  - gitlab.com

unwanted_dirs:
  - ~/snap

self_repos:
  - name: cli/cli
  - name: https://gitlab.com/gitlab-org/cli/
  - name: qmk/qmk_firmware
    submodule: true
    remotes:
      upstream: https://github.com/zsa/qmk_firmware.git

user_in_group:
  # Made up example
  root:
    - video

ensure_lines:
  - name: replace
    file: /etc/dnf/automatic.conf
    text: apply_updates = no
    replace: apply_updates = yes
    when: is-fedora
  - name: replace
    file: /etc/systemd/logind.conf
    text: '#HandleLidSwitchDocked=ignore'
    replace: HandleLidSwitchDocked=suspend
    when: is-laptop
