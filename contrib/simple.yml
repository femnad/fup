settings:
  clone_dir: ~/z/gl
  extract_dir: ~/z/dy
  virtualenv_dir: ~/.local/share/venv
  versions:
    chezmoi: 2.29.0

preflight:
  - task: Enable RPM Fusion
    when: is-fedora
    steps:
      - name: shell
        cmd: dnf install -y https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm
        sudo: true
    unless:
      cmd: dnf list --installed rpmfusion-free-release
  - task: Enable Docker repo
    when: is-fedora
    steps:
      - name: shell
        cmd: |
          sudo dnf -y install dnf-plugins-core
          sudo dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo
        sudo: true
    unless:
      cmd: dnf list --installed docker-ce
  - task: Add Spotify repo
    when: is-ubuntu
    unless:
      stat: /etc/apt/sources.list.d/spotify.list
    steps:
      - name: shell
        sudo: true
        cmd: |
          curl -sS https://download.spotify.com/debian/pubkey_5E3C45D7B312C643.gpg | sudo apt-key add -
          echo 'deb http://repository.spotify.com stable non-free' | sudo tee /etc/apt/sources.list.d/spotify.list
          apt update

archives:
  - url: https://github.com/twpayne/chezmoi/releases/download/v${version}/chezmoi_${version}_linux_amd64.tar.gz
    name: chezmoi
    unless:
      cmd: chezmoi --version
      post: split 2 | cut 1 | cut -1
    target: chezmoi
    link:
      - chezmoi/chezmoi

packages:
  .*:
    - tmux
  ubuntu:
    - suckless-tools
  fedora:
    - NetworkManager-tui

unwanted_packages:
  ubuntu:
    - snapd

cargo:
  - name: git-delta
    unless:
      cmd: delta -V
      # Escape characters in -V output for 0.14.0
      post: head 0 | split 1
    version: 0.14.0

tasks:
  - task: Neovim packages
    when: not neovim-ready
    steps:
      - name: cmd
        cmd: nvim +PlugInstall +qa
  - task: Clone and link clipnotify
    unless:
      cmd: which clipnotify
    steps:
      - name: git
        repo: https://github.com/cdown/clipnotify.git
        dir: ${clone_dir}/clipnotify
      - name: cmd
        cmd: make install
        pwd: ${clone_dir}/clipnotify
        sudo: true
        unless:
          cmd: which clipnotify
  - task: Install Spotify on fedora
    when: is-fedora
    steps:
      - name: cmd
        cmd: flatpak remote-add flathub https://flathub.org/repo/flathub.flatpakrepo
        sudo: true
        unless:
          cmd: flatpak remotes
          post: contains flathub
      - name: cmd
        cmd: flatpak install -y flathub com.spotify.Client
        unless:
          cmd: flatpak list
          post: contains
      - name: template
        target: ${HOME}/bin/spotify
        mode: '0755'
        content: |
          #!/usr/bin/env bash
          flatpak run com.spotify.Client

go:
  - name: gitlab.com/gitlab-org/cli/cmd/glab
    unless:
      cmd: glab version
  - name: charmbracelet/glow
    unless:
      cmd: glow --version
  - name: gokcehan/lf
    unless:
      cmd: lf -version

python:
  - name: tuir
    link:
      - tuir

services:
  - name: grobi
    unit:
      exec: grobi watch
      desc: Automatically configure monitors/outputs for Xorg via RANDR
      env:
        GROBI_CONFIG: ${HOME}/.config/grobi.conf
    dont_start: true
    dont_enable: true
